<!DOCTYPE html>
<html>
<head>
    <title>Razorpay Payment Demo</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <h2>Pay with Razorpay</h2>

  
    <input type="number" id="orderId" placeholder="Enter Order ID" />
    <button id="payBtn">Pay Now</button>

    <script>
        document.getElementById("payBtn").onclick = async function () {
            const orderId = document.getElementById("orderId").value;

            if (!orderId || orderId <= 0) {
                alert("Please enter a valid Order ID");
                return;
            }

            const token = localStorage.getItem("token");
            if (!token) {
                alert("You must login first!");
                return;
            }

            try {
               
                const res = await fetch("https://localhost:7101/api/payment/create", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ orderId: parseInt(orderId) })
                });

                const result = await res.json();

                if (!result.success) {
                    alert("Failed to create payment: " + result.message);
                    return;
                }

                const paymentData = result.data;
                console.log("Payment Created:", paymentData);

                
                var options = {
                    "key": "rzp_test_RJB4Gyco5eulIB", 
                    "amount": paymentData.amount * 100,
                    "currency": paymentData.currency,
                    "name": "ONSTEPS",
                    "description": "Order Payment",
                    "order_id": paymentData.razorpayOrderId,
                    "handler": async function(response) {
                        console.log("Payment Response:", response);

                      
                        const verifyRes = await fetch("https://localhost:7101/api/payment/verify", {
                            method: "POST",
                            headers: { 
                                "Content-Type": "application/json",
                                "Authorization": "Bearer " + token
                            },
                            body: JSON.stringify({
                                orderId: paymentData.orderId,
                                razorpayPaymentId: response.razorpay_payment_id,
                                razorpayOrderId: response.razorpay_order_id,
                                razorpaySignature: response.razorpay_signature,
                                status: "Paid"
                            })
                        });

                        const verifyResult = await verifyRes.json();
                        console.log("Verification Response:", verifyResult);

                        if (verifyResult.success) {
                            alert("✅ Payment Successful and Verified!");
                        } else {
                            alert("❌ Payment Verification Failed!");
                        }
                    },
                    "prefill": {
                        "name": paymentData.userName,
                        "email": paymentData.userEmail,
                        "contact": paymentData.userContact
                    },
                    "theme": { "color": "#3399cc" }
                };

            
                const rzp = new Razorpay(options);
                rzp.open();

            } catch (err) {
                console.error("Error:", err);
                alert("Something went wrong!");
            }
        };
    </script>
</body>
</html>
